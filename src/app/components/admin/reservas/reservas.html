<div class="admin-container">
  <div class="admin-header">
    <h1>ğŸ“… GestiÃ³n de Reservas</h1>
    <button ubButton size="sm" variant="outline" (click)="volverPanel()">â† Volver al Panel</button>
  </div>

  <!-- EstadÃ­sticas -->
  <div class="estadisticas-container" *ngIf="!loading">
    <div ubCard class="stat-card stat-total">
      <div ubCardContent>
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-info">
          <div class="stat-value">{{ getTotalReservas() }}</div>
          <div class="stat-label">Total Reservas</div>
        </div>
      </div>
    </div>
    <div ubCard class="stat-card stat-pendiente">
      <div ubCardContent>
        <div class="stat-icon">â³</div>
        <div class="stat-info">
          <div class="stat-value">{{ getReservasPorEstado('pendiente') }}</div>
          <div class="stat-label">Pendientes</div>
        </div>
      </div>
    </div>
    <div ubCard class="stat-card stat-confirmada">
      <div ubCardContent>
        <div class="stat-icon">âœ…</div>
        <div class="stat-info">
          <div class="stat-value">{{ getReservasPorEstado('confirmada') }}</div>
          <div class="stat-label">Confirmadas</div>
        </div>
      </div>
    </div>
    <div ubCard class="stat-card stat-completada">
      <div ubCardContent>
        <div class="stat-icon">âœ“</div>
        <div class="stat-info">
          <div class="stat-value">{{ getReservasPorEstado('completada') }}</div>
          <div class="stat-label">Completadas</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div ubCard class="filtros-card">
    <div ubCardContent>
      <div class="filtros">
        <div class="filtro-group">
          <label ubLabel>ğŸ” Buscar Usuario/Destino</label>
          <input ubInput type="text" [(ngModel)]="busquedaTexto" (input)="filtrar()" placeholder="Buscar por nombre..." />
        </div>
        <div class="filtro-group">
          <label ubLabel>Estado</label>
          <select ubSelect [(ngModel)]="filtroEstado" (change)="filtrar()">
            <option value="">Todos los estados</option>
            <option value="pendiente">â³ Pendiente</option>
            <option value="confirmada">âœ… Confirmada</option>
            <option value="cancelada">âŒ Cancelada</option>
            <option value="completada">âœ“ Completada</option>
          </select>
        </div>
        <div class="filtro-group">
          <label ubLabel>Ordenar por</label>
          <select ubSelect [(ngModel)]="ordenamiento" (change)="filtrar()">
            <option value="fecha-desc">MÃ¡s reciente primero</option>
            <option value="fecha-asc">MÃ¡s antigua primero</option>
            <option value="precio-desc">Mayor precio</option>
            <option value="precio-asc">Menor precio</option>
          </select>
        </div>
        <div class="filtro-actions">
          <button ubButton variant="outline" size="sm" (click)="limpiarFiltros()">ğŸ”„ Limpiar Filtros</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div ubCard *ngFor="let i of [1, 2, 3]">
      <div ubCardContent>
        <div ubSkeleton class="skeleton-line"></div>
        <div ubSkeleton class="skeleton-line-short"></div>
      </div>
    </div>
  </div>

  <!-- Tabla de Reservas -->
  <div *ngIf="!loading && reservasFiltradas.length > 0" ubCard class="reservas-table-card">
    <div ubCardHeader>
      <div class="table-header">
        <h3 ubCardTitle>ğŸ“‹ Reservas ({{ reservasFiltradas.length }})</h3>
      </div>
    </div>
    <div ubCardContent>
      <div class="reservas-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Destino</th>
              <th>Fechas del Viaje</th>
              <th>DÃ­as</th>
              <th>Personas</th>
              <th>Precio Total</th>
              <th>Estado</th>
              <th>Fecha Reserva</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let reserva of reservasFiltradas; let i = index">
              <td class="td-id">#{{ reservasFiltradas.length - i }}</td>
              <td class="td-usuario">
                <div class="user-info">
                  <div class="user-avatar">{{ getIniciales(reserva) }}</div>
                  <span>{{ getNombreUsuario(reserva) }}</span>
                </div>
              </td>
              <td class="td-email">{{ getEmailUsuario(reserva) }}</td>
              <td class="td-destino">
                <div class="destino-info">
                  <strong>{{ getNombreDestino(reserva) }}</strong>
                </div>
              </td>
              <td class="td-fechas">
                <div class="fecha-rango">
                  <div>ğŸ“… {{ formatearFecha(reserva.fechaInicio) }}</div>
                  <div class="fecha-separador">â†’</div>
                  <div>ğŸ“… {{ formatearFecha(reserva.fechaFin) }}</div>
                </div>
              </td>
              <td class="td-dias">{{ getDiasEstadia(reserva) }} dÃ­as</td>
              <td class="td-personas">
                <span class="personas-badge">ğŸ‘¥ {{ reserva.numeroPersonas }}</span>
              </td>
              <td class="td-precio">
                <strong class="precio-total">{{ formatearPrecio(reserva.precioTotal) }}</strong>
              </td>
              <td class="td-estado">
                <span ubBadge [variant]="getEstadoBadgeVariant(reserva.estado)" class="estado-badge">
                  {{ getEstadoTexto(reserva.estado) }}
                </span>
              </td>
              <td class="td-fecha-creacion">
                <div class="fecha-small">{{ formatearFechaCreacion(reserva.createdAt) }}</div>
              </td>
              <td class="td-acciones">
                <div class="acciones">
                  <button
                    ubButton
                    size="sm"
                    variant="default"
                    *ngIf="reserva.estado === 'pendiente'"
                    (click)="confirmarReservaRapida(reserva)"
                    title="Confirmar reserva"
                  >
                    âœ…
                  </button>
                  <button
                    ubButton
                    size="sm"
                    variant="outline"
                    (click)="abrirModalEditar(reserva)"
                    title="Editar estado"
                  >
                    âœï¸
                  </button>
                  <button
                    ubButton
                    size="sm"
                    variant="destructive"
                    *ngIf="reserva.estado !== 'cancelada' && reserva.estado !== 'completada'"
                    (click)="cancelarReserva(reserva)"
                    title="Cancelar reserva"
                  >
                    âŒ
                  </button>
                  <button
                    ubButton
                    size="sm"
                    variant="secondary"
                    (click)="verDetalles(reserva)"
                    title="Ver detalles completos"
                  >
                    ğŸ‘ï¸
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && reservasFiltradas.length === 0 && reservas.length === 0" ubCard class="empty-state">
    <div ubCardContent>
      <p>ğŸ“… No hay reservas registradas</p>
      <p class="empty-subtitle">
        Las reservas aparecerÃ¡n aquÃ­ cuando los usuarios realicen reservas
      </p>
    </div>
  </div>

  <!-- Empty State - Sin resultados de filtro -->
  <div *ngIf="!loading && reservasFiltradas.length === 0 && reservas.length > 0" ubCard class="empty-state">
    <div ubCardContent>
      <p>ğŸ” No se encontraron reservas</p>
      <p class="empty-subtitle">
        No hay reservas que coincidan con los filtros aplicados
      </p>
      <button ubButton variant="outline" (click)="limpiarFiltros()">Limpiar Filtros</button>
    </div>
  </div>
</div>

<!-- Modal Editar Estado -->
<div class="modal-overlay" *ngIf="mostrarModalEditar && reservaSeleccionada" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>âœï¸ Editar Estado de Reserva</h3>
      <button class="modal-close" (click)="cerrarModal()">âœ•</button>
    </div>
    
    <div class="modal-body">
      <!-- InformaciÃ³n de la Reserva -->
      <div class="reserva-info-card">
        <div class="info-row">
          <div class="info-icon">ğŸ‘¤</div>
          <div class="info-content">
            <label class="info-label">Usuario</label>
            <p class="info-value">{{ getNombreUsuario(reservaSeleccionada) }}</p>
            <p class="info-secondary">{{ getEmailUsuario(reservaSeleccionada) }}</p>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">ğŸ–ï¸</div>
          <div class="info-content">
            <label class="info-label">Destino</label>
            <p class="info-value">{{ getNombreDestino(reservaSeleccionada) }}</p>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">ğŸ“…</div>
          <div class="info-content">
            <label class="info-label">Fechas del Viaje</label>
            <p class="info-value">
              {{ formatearFecha(reservaSeleccionada.fechaInicio) }} â†’ {{ formatearFecha(reservaSeleccionada.fechaFin) }}
            </p>
            <p class="info-secondary">{{ getDiasEstadia(reservaSeleccionada) }} dÃ­as de estadÃ­a</p>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">ğŸ‘¥</div>
          <div class="info-content">
            <label class="info-label">Personas</label>
            <p class="info-value">{{ reservaSeleccionada.numeroPersonas }} pasajeros</p>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">ğŸ’°</div>
          <div class="info-content">
            <label class="info-label">Precio Total</label>
            <p class="info-value precio-destacado">{{ formatearPrecio(reservaSeleccionada.precioTotal) }}</p>
          </div>
        </div>

        <div class="info-row">
          <div class="info-icon">ğŸ“Š</div>
          <div class="info-content">
            <label class="info-label">Estado Actual</label>
            <span ubBadge [variant]="getEstadoBadgeVariant(reservaSeleccionada.estado)">
              {{ getEstadoTexto(reservaSeleccionada.estado) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Separador -->
      <div class="modal-divider"></div>

      <!-- Formulario de EdiciÃ³n -->
      <div class="form-section">
        <h4 class="section-title">Actualizar Estado</h4>
        
        <div class="form-group">
          <label ubLabel class="form-label">
            <span class="label-icon">ğŸ”„</span>
            Nuevo Estado *
          </label>
          <select ubSelect [(ngModel)]="nuevoEstado" class="estado-select">
            <option value="pendiente">â³ Pendiente - En espera de confirmaciÃ³n</option>
            <option value="confirmada">âœ… Confirmada - Reserva aprobada</option>
            <option value="cancelada">âŒ Cancelada - Reserva cancelada</option>
            <option value="completada">âœ“ Completada - Viaje finalizado</option>
          </select>
        </div>

        <div class="form-group alert-info" *ngIf="nuevoEstado === 'confirmada'">
          <div class="alert-icon">â„¹ï¸</div>
          <p>Al confirmar, el usuario recibirÃ¡ una notificaciÃ³n con los detalles de su reserva.</p>
        </div>

        <div class="form-group" *ngIf="nuevoEstado === 'cancelada'">
          <label ubLabel class="form-label">
            <span class="label-icon">ğŸ“</span>
            Motivo de CancelaciÃ³n
          </label>
          <textarea
            ubInput
            type="text"
            [(ngModel)]="motivoCancelacion"
            rows="3"
            class="motivo-textarea"
            placeholder="Ejemplo: No hay disponibilidad en las fechas solicitadas..."
          ></textarea>
          <small class="form-hint">Este mensaje serÃ¡ visible para el usuario</small>
        </div>

        <div class="form-group alert-warning" *ngIf="nuevoEstado === 'cancelada'">
          <div class="alert-icon">âš ï¸</div>
          <p>Esta acciÃ³n no se puede deshacer. AsegÃºrate de ingresar un motivo claro.</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button ubButton variant="outline" (click)="cerrarModal()" class="btn-cancelar">
        Cancelar
      </button>
      <button ubButton (click)="actualizarEstado()" class="btn-guardar">
        ğŸ’¾ Guardar Cambios
      </button>
    </div>
  </div>
</div>
